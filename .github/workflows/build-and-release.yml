name: Build and Release Chemical-Bootstrap

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - os: windows
            arch: x64
            runner: windows-2025
          - os: windows
            arch: arm64
            runner: windows-11-arm
          - os: ubuntu
            arch: x64
            runner: ubuntu-24.04
          - os: ubuntu
            arch: arm64
            runner: ubuntu-24.04-arm
          - os: macos
            arch: x64
            runner: macos-15-intel
          - os: macos
            arch: arm64
            runner: macos-26

    steps:
      # Checkout chemical-bootstrap only
      - name: Checkout chemical-bootstrap
        uses: actions/checkout@v4
        with:
          repository: chemicallang/chemical-bootstrap
          token: ${{ secrets.GITHUB_TOKEN }}
          path: chemical-bootstrap

      # Build chemical-bootstrap
      - name: Build chemical-bootstrap
        working-directory: chemical-bootstrap
        shell: bash
        run: |
          chmod +x build || true
          ./build native-${{ matrix.os }}-gnu native

      - name: Compress build
        id: compress
        working-directory: chemical-bootstrap
        shell: bash
        run: |
          OUT_DIR=out
          ZIP_NAME="${{ matrix.os }}-${{ matrix.arch }}.zip"
          rm -f "$ZIP_NAME"
          if [ "${{ matrix.os }}" = "windows" ]; then
            # Use PowerShell Core on Windows runners to create a zip
            pwsh -NoProfile -NonInteractive -Command "Add-Type -AssemblyName System.IO.Compression.FileSystem; [System.IO.Compression.ZipFile]::CreateFromDirectory('${OUT_DIR}', '${ZIP_NAME}')"
          else
            zip -r "$ZIP_NAME" "$OUT_DIR"
          fi
          echo "zip_file=$ZIP_NAME" >> $GITHUB_OUTPUT

      # Create a release if none exists
      - name: Create release
        id: release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: bootstrap-${{ github.run_number }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Upload zip to release
      - name: Upload release asset
        uses: softprops/action-gh-release@v1
        with:
          tag_name: bootstrap-${{ github.run_number }}
          files: chemical-bootstrap/${{ steps.compress.outputs.zip_file }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}