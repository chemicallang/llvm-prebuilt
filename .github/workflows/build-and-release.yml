name: Build and Release Chemical-Bootstrap

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - os: windows
            arch: x64
            runner: windows-2025
          - os: windows
            arch: arm64
            runner: windows-11-arm
          - os: ubuntu
            arch: x64
            runner: ubuntu-24.04
          - os: ubuntu
            arch: arm64
            runner: ubuntu-24.04-arm
          - os: macos
            arch: x64
            runner: macos-15-intel
          - os: macos
            arch: arm64
            runner: macos-26

    steps:
      # Checkout chemical-bootstrap
      - name: Checkout chemical-bootstrap
        uses: actions/checkout@v4
        with:
          repository: chemicallang/chemical-bootstrap
          token: ${{ secrets.GITHUB_TOKEN }}
          path: chemical-bootstrap

      # Get latest release info (fail if none exists)
      - name: Get latest release
        id: get_release
        uses: actions/github-script@v6
        with:
          script: |
            const releases = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            const latest = releases.data.find(r => !r.draft && !r.prerelease);
            if (!latest) {
              throw new Error("No release exists! Create a release manually before running this workflow.");
            }
            core.setOutput("id", latest.id);
            core.setOutput("tag", latest.tag_name);

      # Build chemical-bootstrap
      - name: Build chemical-bootstrap
        working-directory: chemical-bootstrap
        shell: bash
        run: |
          chmod +x build || true
          ./build native-${{ matrix.os }}-gnu native

      # Compress build output
      - name: Compress build
        id: compress
        working-directory: chemical-bootstrap
        shell: bash
        run: |
          OUT_DIR=out
          ZIP_NAME="${{ matrix.os }}-${{ matrix.arch }}.zip"
          rm -f "$ZIP_NAME"
          if [ "${{ matrix.os }}" = "windows" ]; then
            pwsh -NoProfile -NonInteractive -Command "$p='${PWD}/$OUT_DIR'; [System.IO.Compression.ZipFile]::CreateFromDirectory($p, '${PWD}/$ZIP_NAME')"
          else
            zip -r "$ZIP_NAME" "$OUT_DIR"
          fi
          echo "zip_file=$ZIP_NAME" >> $GITHUB_OUTPUT

      # Upload to existing release directly
      - name: Upload release asset
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_release.outputs.tag }}
          files: chemical-bootstrap/${{ steps.compress.outputs.zip_file }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
