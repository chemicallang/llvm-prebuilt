name: Build and Deploy on Commit

permissions:
  contents: write

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-windows:
    name: Build on Windows (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x64
            runner: windows-2025
          - arch: arm64
            runner: windows-11-arm
    steps:
      # ––– Checkout repositories –––
      - name: Checkout chemical-bootstrap repository
        uses: actions/checkout@v4
        with:
          repository: chemicallang/chemical-bootstrap
          token: ${{ secrets.GITHUB_TOKEN }}
          path: chemical-bootstrap

      # ––– Setup build environment –––
      - name: Set up Visual Studio Developer Command Prompt
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: ${{ matrix.arch }}

      # Get the SHA of the chemical-bootstrap repository
      - name: Get SHA of chemical-bootstrap repository
        id: get-sha
        shell: pwsh
        working-directory: chemical-bootstrap
        run: |
          $sha = (git rev-parse HEAD).Trim()
          echo "sha=$sha" >> $env:GITHUB_OUTPUT

      # Build the chemical-bootstrap project (only if not cached)
      - name: Build chemical-bootstrap (Windows)
        working-directory: chemical-bootstrap
        run: .\build.bat native-windows-gnu native

      # Save the out-win folder as cache
      # TODO: save out-win folder as a release asset into the latest release
      # - name: Save cache for chemical-bootstrap/out-win
      #   if: success()
      #   id: bootstrap-cache-save
      #   uses: actions/cache/save@v4
      #   with:
      #     path: chemical-bootstrap/out-win/
      #     key: ${{ runner.os }}-${{ steps.get-sha.outputs.sha }}-${{ matrix.arch }}

      # ––– Get information about the latest release –––
      - name: Get latest release info
        id: get_latest_release
        uses: actions/github-script@v6
        with:
          script: |
            const releasesResponse = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            const validReleases = releasesResponse.data.filter(release => !release.draft);
            
            if (validReleases.length === 0) {
              throw new Error("No published or pre-releases found.");
            }
            
            const latestRelease = validReleases[0];
            core.setOutput("tag", latestRelease.tag_name);
            core.setOutput("id", latestRelease.id);


      # TODO: zip file is NOT present at the moment
      # Upload release assets
      - name: Upload release assets
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_latest_release.outputs.tag }}
          files: |
            windows-${{ matrix.arch }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-linux:
    name: Build on Linux (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - arch: x64
            runner: ubuntu-24.04
          - arch: arm64
            runner: ubuntu-24.04-arm
    steps:
      # ––– Checkout repositories –––
      - name: Checkout chemical-bootstrap repository
        uses: actions/checkout@v4
        with:
          repository: chemicallang/chemical-bootstrap
          token: ${{ secrets.GITHUB_TOKEN }}
          path: chemical-bootstrap

      # ––– Install dependencies –––
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake git

      # Get the SHA of the chemical-bootstrap repository
      - name: Get SHA of chemical-bootstrap repository
        id: get-sha
        working-directory: chemical-bootstrap
        run: |
          SHA=$(git rev-parse HEAD | xargs)
          echo "sha=$SHA" >> $GITHUB_OUTPUT

      # Build the chemical-bootstrap project (Linux) (only if not cached)
      - name: Build chemical-bootstrap
        working-directory: chemical-bootstrap
        run: ./build native-linux-gnu native

      # TODO: save out folder as a release asset into the latest release
      # saves the out folder in cache
      # - name: Save cache for chemical-bootstrap
      #   if: success()
      #   id: bootstrap-cache-save
      #   uses: actions/cache/save@v4
      #   with:
      #     path: chemical-bootstrap/out/
      #     key: ${{ runner.os }}-${{ steps.get-sha.outputs.sha }}-${{ matrix.arch }}

      # ––– Get information about the latest release –––
      - name: Get latest release info
        id: get_latest_release
        uses: actions/github-script@v6
        with:
          script: |
            const releasesResponse = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            const validReleases = releasesResponse.data.filter(release => !release.draft);
            
            if (validReleases.length === 0) {
              throw new Error("No published or pre-releases found.");
            }
            
            const latestRelease = validReleases[0];
            core.setOutput("tag", latestRelease.tag_name);
            core.setOutput("id", latestRelease.id);

      # TODO: zip file is NOT present at the moment
      - name: Upload release artifacts
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_latest_release.outputs.tag }}
          files: |
            linux-${{ matrix.arch }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-alpine:
    name: Build on Alpine Linux (${{ matrix.arch }})
    container:
      image: alpine:3.20
    runs-on: ${{ matrix.runner }}
    if: contains(github.event.head_commit.message, 'releaseIt')
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x64
            runner: ubuntu-24.04
          - arch: arm64
            runner: ubuntu-24.04-arm
    steps:

      # ––– Install dependencies –––
      - name: Install dependencies
        run: |
          apk add --no-cache build-base cmake ninja git bash python3 curl musl-dev linux-headers zip unzip

      # ––– Checkout repositories –––
      - name: Checkout chemical-bootstrap repository
        uses: actions/checkout@v4
        with:
          repository: chemicallang/chemical-bootstrap
          token: ${{ secrets.GITHUB_TOKEN }}
          path: chemical-bootstrap

      # Get the SHA of the chemical-bootstrap repository
      - name: Get SHA of chemical-bootstrap repository
        id: get-sha
        working-directory: chemical-bootstrap
        run: |
          SHA=$(git rev-parse HEAD | xargs)
          echo "sha=$SHA" >> $GITHUB_OUTPUT

      # Build the chemical-bootstrap project (only if not cached)
      - name: Build chemical-bootstrap
        working-directory: chemical-bootstrap
        run: |
          chmod +x build
          ./build native-linux-gnu native

      # TODO: save out folder as a release asset into the latest release
      # saves the out folder in cache
      # - name: Save cache for chemical-bootstrap
      #   if: success()
      #   id: bootstrap-cache-save
      #   uses: actions/cache/save@v4
      #   with:
      #     path: chemical-bootstrap/out/
      #     key: ${{ runner.os }}-${{ steps.get-sha.outputs.sha }}-${{ matrix.arch }}

      - name: Get latest release info
        id: get_latest_release
        uses: actions/github-script@v6
        with:
          script: |
            const releasesResponse = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            const validReleases = releasesResponse.data.filter(release => !release.draft);
            
            if (validReleases.length === 0) {
              throw new Error("No published or pre-releases found.");
            }
            
            const latestRelease = validReleases[0];
            core.setOutput("tag", latestRelease.tag_name);
            core.setOutput("id", latestRelease.id);

      # TODO: zip file is NOT present at the moment
      - name: Upload release artifacts
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_latest_release.outputs.tag }}
          files: |
            linux-alpine-${{ matrix.arch }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-macos:
    name: Build on macOS (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - arch: x64
            runner: macos-15-intel
          - arch: arm64
            runner: macos-26
    steps:
      # ––– Install dependencies –––
      - name: Install Dependencies
        run: |
          brew update
          brew install cmake ninja git

      # ––– Checkout repositories –––
      - name: Checkout chemical-bootstrap repository
        uses: actions/checkout@v4
        with:
          repository: chemicallang/chemical-bootstrap
          token: ${{ secrets.GITHUB_TOKEN }}
          path: chemical-bootstrap

      # Get the SHA of the chemical-bootstrap repository
      - name: Get SHA of chemical-bootstrap repository
        id: get-sha
        working-directory: chemical-bootstrap
        run: |
          SHA=$(git rev-parse HEAD | xargs)
          echo "sha=$SHA" >> $GITHUB_OUTPUT

      # Build chemical-bootstrap project (macOS) (only if not cached)
      - name: Build chemical-bootstrap
        working-directory: chemical-bootstrap
        run: |
          chmod +x build
          ./build native-macos-none native

      # TODO: save out folder as a release asset into the latest release
      # Save cache
      # - name: Save cache for chemical-bootstrap
      #   if: success()
      #   id: bootstrap-cache-save
      #   uses: actions/cache/save@v4
      #   with:
      #     path: chemical-bootstrap/out/
      #     key: ${{ runner.os }}-${{ steps.get-sha.outputs.sha }}-${{ matrix.arch }}

      # Get latest release info
      - name: Get latest release info
        id: get_latest_release
        uses: actions/github-script@v6
        with:
          script: |
            const releasesResponse = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            const validReleases = releasesResponse.data.filter(release => !release.draft);
            if (validReleases.length === 0) {
              throw new Error("No published or pre-releases found.");
            }
            const latestRelease = validReleases[0];
            core.setOutput("tag", latestRelease.tag_name);
            core.setOutput("id", latestRelease.id);

      # TODO: zip file is NOT present at the moment
      # Upload assets
      - name: Upload release assets
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_latest_release.outputs.tag }}
          files: |
            macos-${{ matrix.arch }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}